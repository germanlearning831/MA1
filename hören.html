<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√ñSD Zertifikat A1 - H√∂ren</title>
    <style>
        :root {
            --primary: #2f2a24;
            --accent: #8a7c6a;
            --success: #2f7b3a;
            --error: #b24a3a;
            --bg: #f6f1e7;
            --card-bg: #fdfbf7;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: "Georgia", "Times New Roman", serif;
            background: var(--bg);
            color: var(--primary);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            letter-spacing: 0.02em;
        }

        header {
            background: linear-gradient(180deg, #fdfbf7 0%, #f3ecdf 100%);
            color: var(--primary);
            padding: 1rem 1.25rem;
            text-align: left;
            border-bottom: 1px solid #d8cdbd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            flex: 1;
        }

        header h1 {
            margin: 0;
            font-size: 1.15rem;
            font-weight: 600;
        }

        header p {
            margin: 0.35rem 0 0;
            font-size: 0.9rem;
            color: #4d4336;
        }

        /* Timer Styles */
        .timer-box {
            background: #3f382f;
            color: #fffef9;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .timer-box.warning {
            background: #b24a3a;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .timer-icon {
            font-size: 1.2rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 1.5rem 1rem 2rem;
            background: #fffef9;
            border-left: 1px solid #e0d6c8;
            border-right: 1px solid #e0d6c8;
            min-height: 100vh;
        }

        /* Section Title */
        .section-title {
            border-bottom: 1px solid #c9beaf;
            padding-bottom: 0.4rem;
            margin-bottom: 1rem;
            margin-top: 0;
            color: #3b3329;
            font-weight: 700;
            font-size: 1rem;
            letter-spacing: 0.05em;
        }

        .instructions {
            background: #f9f5ed;
            border: 1px solid #e0d6c8;
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
            color: #4d4336;
        }

        .instructions strong {
            color: var(--primary);
        }

        /* Pictures Grid */
        .pictures-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.25rem;
        }

        .picture-card {
            background: var(--card-bg);
            border: 1px solid #d8cdbd;
            border-radius: 10px;
            overflow: hidden;
            transition: box-shadow 0.2s;
        }

        .picture-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .picture-label {
            background: #3f382f;
            color: #fffef9;
            padding: 0.4rem 0.75rem;
            font-weight: 700;
            font-size: 1rem;
            display: inline-block;
        }

        .picture-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background: #f3ecdf;
            border-bottom: 1px solid #e0d6c8;
        }

        .picture-wrapper {
            padding: 0.75rem;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #faf8f4;
        }

        .picture-wrapper img {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
            display: block;
        }

        .picture-input {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.85rem;
            background: #f6f0e5;
            border-top: 1px solid #e0d6c8;
        }

        .picture-input label {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--primary);
        }

        .picture-input select {
            padding: 8px 14px;
            border: 1px solid #b6aa98;
            border-radius: 5px;
            font-size: 1rem;
            font-family: inherit;
            background: #fffdf8;
            min-width: 70px;
            appearance: none;
            background-image: linear-gradient(45deg, transparent 50%, #8a7c6a 50%),
                              linear-gradient(135deg, #8a7c6a 50%, transparent 50%);
            background-position: calc(100% - 14px) calc(50% - 4px), calc(100% - 8px) calc(50% - 4px);
            background-size: 6px 6px;
            background-repeat: no-repeat;
            cursor: pointer;
        }

        .picture-input select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(47,42,36,0.1);
        }

        /* Submit Button */
        .submit-section {
            margin-top: 2rem;
            text-align: center;
        }

        .primary-btn {
            background: linear-gradient(180deg, #4a4238 0%, #2f2a24 100%);
            color: #fffef9;
            border: none;
            padding: 0.9rem 2.5rem;
            font-size: 1.05rem;
            font-family: inherit;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            transition: all 0.2s;
        }

        .primary-btn:hover {
            background: linear-gradient(180deg, #5a5248 0%, #3f3a34 100%);
            transform: translateY(-1px);
        }

        .primary-btn:disabled {
            background: #b6aa98;
            cursor: not-allowed;
            transform: none;
        }

        /* Notizen Card Styles */
        .notizen-card {
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 1rem;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }

        .notizen-header {
            background: #f5f5f5;
            padding: 0.6rem 1rem;
            font-weight: 600;
            font-size: 0.95rem;
            color: #555;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .notizen-icon {
            font-size: 1rem;
        }

        .notizen-body {
            padding: 1.5rem 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            background: #fff;
        }

        .notizen-row {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .notizen-label {
            font-weight: 700;
            font-size: 1rem;
            color: var(--primary);
            margin-right: 0.5rem;
        }

        .notizen-example {
            font-weight: 700;
            font-size: 1rem;
            color: #333;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-underline-offset: 4px;
        }

        .notizen-inline {
            display: flex;
            flex-wrap: wrap;
            align-items: baseline;
            gap: 0.3rem;
            font-size: 1rem;
            color: #333;
            line-height: 2.2;
        }

        .notizen-input-underline {
            border: none;
            border-bottom: 1.5px dotted #999;
            background: transparent;
            font-family: inherit;
            font-size: 1rem;
            padding: 0.2rem 0.4rem;
            min-width: 50px;
            width: 60px;
            text-align: center;
            outline: none;
        }

        .notizen-input-underline:focus {
            border-bottom-color: var(--primary);
            border-bottom-style: solid;
        }

        .notizen-input-underline.wide {
            width: 120px;
        }

        @media (max-width: 600px) {
            .notizen-inline {
                gap: 0.25rem;
            }
            
            .notizen-input-underline {
                width: 50px;
            }
            
            .notizen-input-underline.wide {
                width: 90px;
            }
        }

        /* Aufgabe 3 Styles */
        .aufgabe3-container {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 1rem;
        }

        .aufgabe3-header-row {
            display: grid;
            grid-template-columns: 80px repeat(4, 1fr);
            background: #f9f9f9;
            border-bottom: 2px solid #ddd;
        }

        .aufgabe3-corner {
            background: #f5f5f5;
        }

        .aufgabe3-destination {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.75rem 0.5rem;
            gap: 0.5rem;
            border-left: 1px solid #eee;
        }

        .aufgabe3-destination img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .aufgabe3-destination span {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--primary);
            text-align: center;
        }

        .aufgabe3-row {
            display: grid;
            grid-template-columns: 80px repeat(4, 1fr);
            border-bottom: 1px solid #eee;
        }

        .aufgabe3-row:last-child {
            border-bottom: none;
        }

        .aufgabe3-row:nth-child(even) {
            background: #fafafa;
        }

        .aufgabe3-text-label {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--primary);
            background: #f5f5f5;
            border-right: 1px solid #eee;
            padding: 0.75rem 0.5rem;
        }

        .aufgabe3-checkbox {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem;
            border-left: 1px solid #eee;
        }

        .aufgabe3-checkbox input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: var(--primary);
            appearance: none;
            -webkit-appearance: none;
            border: 2px solid #666;
            border-radius: 3px;
            background: #fff;
            position: relative;
        }

        .aufgabe3-checkbox input[type="checkbox"]:checked {
            background: #fff;
            border-color: var(--primary);
        }

        .aufgabe3-checkbox input[type="checkbox"]:checked::after {
            content: '‚úï';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
            font-weight: bold;
            color: var(--primary);
        }

        /* Mobile responsive for Aufgabe 3 */
        @media (max-width: 500px) {
            .aufgabe3-header-row {
                grid-template-columns: 60px repeat(4, 1fr);
            }

            .aufgabe3-row {
                grid-template-columns: 60px repeat(4, 1fr);
            }

            .aufgabe3-destination img {
                width: 40px;
                height: 40px;
            }

            .aufgabe3-destination span {
                font-size: 0.7rem;
            }

            .aufgabe3-text-label {
                font-size: 0.75rem;
                padding: 0.5rem 0.25rem;
            }

            .aufgabe3-checkbox {
                padding: 0.5rem 0.25rem;
            }

            .aufgabe3-checkbox input[type="checkbox"] {
                width: 18px;
                height: 18px;
            }

            .aufgabe3-checkbox input[type="checkbox"]:checked::after {
                font-size: 12px;
            }
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 12px;
            z-index: 1001;
            text-align: center;
            min-width: 300px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .modal h2 {
            margin: 0 0 1rem;
            color: var(--primary);
        }

        .modal p {
            margin: 0 0 1.5rem;
            color: #4d4336;
        }

        .modal button {
            padding: 10px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            font-family: inherit;
            font-size: 1rem;
            cursor: pointer;
        }

        /* Mobile Responsive */
        @media (max-width: 600px) {
            .pictures-grid {
                grid-template-columns: 1fr;
            }

            header {
                flex-direction: column;
                gap: 0.75rem;
                text-align: center;
            }

            .header-left {
                order: 1;
            }

            .timer-box {
                order: 0;
                font-size: 1.2rem;
                padding: 0.5rem 1rem;
            }

            .container {
                padding: 1rem 0.75rem;
            }

            .picture-input {
                padding: 0.75rem;
            }
        }
    </style>
</head>
<body>

<header>
    <div class="header-left">
        <h1>üéß H√∂ren</h1>
        <p>Aufgabe 1 & 2 ‚Äì insgesamt ca. 10 Minuten</p>
    </div>
    <div class="timer-box" id="timer-box">
        <span class="timer-icon">‚è±</span>
        <span id="timer-display">20:00</span>
    </div>
</header>

<div class="container">

    <h2 class="section-title">Aufgabe 1 - Bilder</h2>

    <div class="instructions">
        <strong>Situation:</strong> Sehen Sie sich die Bilder gut an. Sie haben 30 Sekunden Zeit. 
        Sie h√∂ren jetzt f√ºnf verschiedene Texte zu den Fotos. Sie h√∂ren jeden Text ein Mal. 
        Welcher Text passt zu welchem Foto? Schreiben Sie die Nummer des Textes unter das Foto. 
        <strong>Achtung: Ein Bild ist zu viel.</strong>
    </div>

    <div class="pictures-grid" id="pictures-container">
        <!-- Pictures will be generated by JavaScript -->
    </div>

    <!-- Aufgabe 2: Notizen -->
    <h2 class="section-title" style="margin-top: 2.5rem;">Aufgabe 2 - Notizen</h2>
    
    <div class="instructions">
        <strong>Lesen Sie Aufgabe 2 gut durch. Sie haben 30 Sekunden Zeit.</strong><br>
        <strong>Situation:</strong> Sie h√∂ren folgende Nachricht. H√∂ren Sie gut zu und schreiben Sie die wichtigsten Informationen auf das Notizblatt. Sie h√∂ren den Text zwei Mal.
    </div>

    <div class="notizen-card" id="notizen-container">
        <div class="notizen-header">
            <span class="notizen-icon">üìù</span> Notizen
        </div>
        <div class="notizen-body">
            <div class="notizen-row">
                <div class="notizen-inline">
                    <span class="notizen-label">Was:</span>
                    <span class="notizen-example">Auto ansehen</span>
                </div>
            </div>
            <div class="notizen-row">
                <div class="notizen-inline">
                    <span class="notizen-label">Wann:</span>
                    <span>am</span>
                    <input type="text" id="notiz-wann-day" class="notizen-input-underline wide" placeholder="">
                    <span>Nachmittag,</span>
                </div>
                <div class="notizen-inline" style="margin-top: 0.5rem; padding-left: 3.5rem;">
                    <input type="text" id="notiz-wann-date" class="notizen-input-underline" placeholder="">
                    <span>Mai, um</span>
                    <input type="text" id="notiz-wann-uhr" class="notizen-input-underline" placeholder="">
                    <span>Uhr</span>
                </div>
            </div>
            <div class="notizen-row">
                <div class="notizen-inline">
                    <span class="notizen-label">Wo:</span>
                    <span>in der</span>
                    <input type="text" id="notiz-wo" class="notizen-input-underline wide" placeholder="">
                    <span>gasse 12</span>
                </div>
            </div>
            <div class="notizen-row">
                <div class="notizen-inline">
                    <span class="notizen-label">Telefonnummer:</span>
                    <span>0664</span>
                    <input type="text" id="notiz-telefon" class="notizen-input-underline wide" placeholder="">
                </div>
            </div>
        </div>
    </div>

    <!-- Aufgabe 3: Wo gef√§llt es Ihnen am besten? -->
    <h2 class="section-title" style="margin-top: 2.5rem;">Aufgabe 3 - Wo gef√§llt es Ihnen am besten?</h2>
    
    <div class="instructions">
        <strong>Lesen Sie Aufgabe 3 gut durch. Sie haben 10 Sekunden Zeit.</strong><br>
        <strong>Situation:</strong> Sie h√∂ren jetzt 5 Personen, die befragt werden. H√∂ren Sie gut zu und kreuzen Sie die richtigen Antworten an. Pro Person gibt es nur eine Antwort. Sie h√∂ren die Texte ein Mal.
    </div>

    <div class="aufgabe3-container">
        <div class="aufgabe3-header-row">
            <div class="aufgabe3-corner"></div>
            <div class="aufgabe3-destination">
                <img src="hl/a.png" alt="Afrika">
                <span>Afrika</span>
            </div>
            <div class="aufgabe3-destination">
                <img src="hl/b.png" alt="Amerika">
                <span>Amerika</span>
            </div>
            <div class="aufgabe3-destination">
                <img src="hl/c.png" alt="Asien">
                <span>Asien</span>
            </div>
            <div class="aufgabe3-destination">
                <img src="hl/d.png" alt="Europa">
                <span>Europa</span>
            </div>
        </div>
        
        <div class="aufgabe3-row" id="aufgabe3-row-1">
            <div class="aufgabe3-text-label">Text 1</div>
            <div class="aufgabe3-checkbox"><input type="checkbox" name="aufgabe3-1" value="Afrika" onchange="handleCheckbox(this, 'aufgabe3-1')"></div>
            <div class="aufgabe3-checkbox"><input type="checkbox" name="aufgabe3-1" value="Amerika" onchange="handleCheckbox(this, 'aufgabe3-1')"></div>
            <div class="aufgabe3-checkbox"><input type="checkbox" name="aufgabe3-1" value="Asien" onchange="handleCheckbox(this, 'aufgabe3-1')"></div>
            <div class="aufgabe3-checkbox"><input type="checkbox" name="aufgabe3-1" value="Europa" onchange="handleCheckbox(this, 'aufgabe3-1')"></div>
        </div>
        <div class="aufgabe3-row" id="aufgabe3-row-2">
            <div class="aufgabe3-text-label">Text 2</div>
            <div class="aufgabe3-checkbox"><input type="checkbox" name="aufgabe3-2" value="Afrika" onchange="handleCheckbox(this, 'aufgabe3-2')"></div>
            <div class="aufgabe3-checkbox"><input type="checkbox" name="aufgabe3-2" value="Amerika" onchange="handleCheckbox(this, 'aufgabe3-2')"></div>
            <div class="aufgabe3-checkbox"><input type="checkbox" name="aufgabe3-2" value="Asien" onchange="handleCheckbox(this, 'aufgabe3-2')"></div>
            <div class="aufgabe3-checkbox"><input type="checkbox" name="aufgabe3-2" value="Europa" onchange="handleCheckbox(this, 'aufgabe3-2')"></div>
        </div>
        <div class="aufgabe3-row" id="aufgabe3-row-3">
            <div class="aufgabe3-text-label">Text 3</div>
            <div class="aufgabe3-checkbox"><input type="checkbox" name="aufgabe3-3" value="Afrika" onchange="handleCheckbox(this, 'aufgabe3-3')"></div>
            <div class="aufgabe3-checkbox"><input type="checkbox" name="aufgabe3-3" value="Amerika" onchange="handleCheckbox(this, 'aufgabe3-3')"></div>
            <div class="aufgabe3-checkbox"><input type="checkbox" name="aufgabe3-3" value="Asien" onchange="handleCheckbox(this, 'aufgabe3-3')"></div>
            <div class="aufgabe3-checkbox"><input type="checkbox" name="aufgabe3-3" value="Europa" onchange="handleCheckbox(this, 'aufgabe3-3')"></div>
        </div>
        <div class="aufgabe3-row" id="aufgabe3-row-4">
            <div class="aufgabe3-text-label">Text 4</div>
            <div class="aufgabe3-checkbox"><input type="checkbox" name="aufgabe3-4" value="Afrika" onchange="handleCheckbox(this, 'aufgabe3-4')"></div>
            <div class="aufgabe3-checkbox"><input type="checkbox" name="aufgabe3-4" value="Amerika" onchange="handleCheckbox(this, 'aufgabe3-4')"></div>
            <div class="aufgabe3-checkbox"><input type="checkbox" name="aufgabe3-4" value="Asien" onchange="handleCheckbox(this, 'aufgabe3-4')"></div>
            <div class="aufgabe3-checkbox"><input type="checkbox" name="aufgabe3-4" value="Europa" onchange="handleCheckbox(this, 'aufgabe3-4')"></div>
        </div>
        <div class="aufgabe3-row" id="aufgabe3-row-5">
            <div class="aufgabe3-text-label">Text 5</div>
            <div class="aufgabe3-checkbox"><input type="checkbox" name="aufgabe3-5" value="Afrika" onchange="handleCheckbox(this, 'aufgabe3-5')"></div>
            <div class="aufgabe3-checkbox"><input type="checkbox" name="aufgabe3-5" value="Amerika" onchange="handleCheckbox(this, 'aufgabe3-5')"></div>
            <div class="aufgabe3-checkbox"><input type="checkbox" name="aufgabe3-5" value="Asien" onchange="handleCheckbox(this, 'aufgabe3-5')"></div>
            <div class="aufgabe3-checkbox"><input type="checkbox" name="aufgabe3-5" value="Europa" onchange="handleCheckbox(this, 'aufgabe3-5')"></div>
        </div>
    </div>

    <div class="submit-section">
        <button class="primary-btn" id="submit-btn" onclick="submitAnswers()">Antworten abgeben</button>
    </div>

</div>

<!-- Modal -->
<div class="modal-overlay" id="modal-overlay"></div>
<div class="modal" id="result-modal">
    <h2 id="modal-title">Abgeschlossen</h2>
    <p id="modal-score">Vielen Dank! Ihre Antworten wurden √ºbermittelt.</p>
    <button onclick="closeModal()">Schlie√üen</button>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwC46yRjiLRc6UAtV1bLj8ecb60vXg76-2g13KtDOgOURKL74tYDnUGQKzYhEHqgO0VXg/exec';
    const EXAM_NAME = 'H√∂ren Teil 1';

    // Timer variables (20 minutes for H√∂ren)
    let timeRemaining = 20 * 60;
    let timerInterval = null;
    let hasSubmitted = false;

    // Pictures data (A-F) with correct answers
    // A=5, B=no answer (null), C=2, D=4, E=1, F=3
    const pictures = [
        { id: 'A', image: 'hl/1.png', correct: 5 },
        { id: 'B', image: 'hl/2.png', correct: null }, // No matching text - ignored in scoring
        { id: 'C', image: 'hl/3.png', correct: 2 },
        { id: 'D', image: 'hl/4.png', correct: 4 },
        { id: 'E', image: 'hl/5.png', correct: 1 },
        { id: 'F', image: 'hl/6.png', correct: 3 }
    ];

    // Aufgabe 1 scoring table: 5 correct = 10, 4 = 8, 3 = 6, 2 = 4, 1 = 2, 0 = 0
    const aufgabe1ScoreTable = [0, 2, 4, 6, 8, 10];

    // Handle checkbox - only one per row
    function handleCheckbox(checkbox, groupName) {
        if (checkbox.checked) {
            // Uncheck all other checkboxes in the same row
            document.querySelectorAll(`input[name="${groupName}"]`).forEach(cb => {
                if (cb !== checkbox) cb.checked = false;
            });
        }
    }

    // Generate picture cards
    function generatePictures() {
        const container = document.getElementById('pictures-container');
        
        pictures.forEach(pic => {
            const card = document.createElement('div');
            card.className = 'picture-card';
            card.innerHTML = `
                <div class="picture-header">
                    <span class="picture-label">${pic.id}</span>
                </div>
                <div class="picture-wrapper">
                    <img src="${pic.image}" alt="Bild ${pic.id}">
                </div>
                <div class="picture-input">
                    <label>Text Nr.:</label>
                    <select id="select-${pic.id}">
                        <option value="">-</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
            `;
            container.appendChild(card);
        });
    }

    // Timer functions
    function startTimer() {
        const timerDisplay = document.getElementById('timer-display');
        const timerBox = document.getElementById('timer-box');
        
        timerInterval = setInterval(() => {
            timeRemaining--;
            
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeRemaining <= 2 * 60) {
                timerBox.classList.add('warning');
            }
            
            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                timerDisplay.textContent = '00:00';
                autoSubmit();
            }
        }, 1000);
    }

    function autoSubmit() {
        document.querySelectorAll('select, input[type="text"], input[type="radio"], input[type="checkbox"]').forEach(el => el.setAttribute('disabled', 'true'));
        document.getElementById('submit-btn')?.setAttribute('disabled', 'true');
        submitToSheet();
        showResultModal();
    }

    function submitAnswers() {
        if (!confirm('M√∂chten Sie Ihre Antworten abgeben? Sie k√∂nnen danach nichts mehr √§ndern.')) {
            return;
        }

        clearInterval(timerInterval);
        document.querySelectorAll('select, input[type="text"], input[type="radio"], input[type="checkbox"]').forEach(el => el.setAttribute('disabled', 'true'));
        document.getElementById('submit-btn')?.setAttribute('disabled', 'true');
        
        submitToSheet();
        showResultModal();
    }

    function submitToSheet() {
        if (hasSubmitted) return;
        hasSubmitted = true;

        // Collect Aufgabe 1 answers (pictures)
        const aufgabe1Answers = {};
        let correctCount1 = 0;
        
        pictures.forEach(pic => {
            const select = document.getElementById(`select-${pic.id}`);
            const userVal = select.value;
            aufgabe1Answers[pic.id] = userVal;
            
            // Only count correct answers for pictures that have a correct answer (not B)
            // No negative marks - wrong answers just don't add points
            if (pic.correct !== null && parseInt(userVal) === pic.correct) {
                correctCount1++;
            }
        });

        // Convert correct count to points using scoring table
        const score1 = aufgabe1ScoreTable[correctCount1] || 0;

        // Helper function to normalize input (remove spaces, special chars, lowercase)
        function normalizeInput(str) {
            if (!str) return '';
            return str.toLowerCase().replace(/[^a-z0-9√§√∂√º√ü]/gi, '');
        }

        // Helper function for fuzzy day matching (Dienstag/Di with spelling tolerance)
        function isDayCorrect(input) {
            const normalized = normalizeInput(input);
            if (!normalized) return false;
            
            // Accept "di" or starts with "di" (Dienstag, Diensta, etc.)
            // Also accept common misspellings like "diensatg", "dinstag", "dienstga"
            if (normalized === 'di') return true;
            if (normalized.startsWith('di') && normalized.length >= 2) {
                // Check if it's close to "dienstag" - must have at least d, i, e, n, s, t, a, g
                const hasD = normalized.includes('d');
                const hasI = normalized.includes('i');
                const hasE = normalized.includes('e');
                const hasN = normalized.includes('n');
                const hasS = normalized.includes('s');
                const hasT = normalized.includes('t');
                // If contains most key letters of dienstag, accept it
                const matchCount = [hasD, hasI, hasE, hasN, hasS, hasT].filter(x => x).length;
                if (matchCount >= 4) return true;
            }
            return false;
        }

        // Collect Aufgabe 2 answers (Notizen) and score
        // Format: Wann: am [day name] Nachmittag, [date] Mai, um [hour] Uhr
        const rawWannDay = document.getElementById('notiz-wann-day')?.value || '';
        const rawWannDate = document.getElementById('notiz-wann-date')?.value || '';
        const rawWannUhr = document.getElementById('notiz-wann-uhr')?.value || '';
        const rawWo = document.getElementById('notiz-wo')?.value || '';
        const rawTelefon = document.getElementById('notiz-telefon')?.value || '';

        const aufgabe2Answers = {
            was: 'Auto ansehen', // Pre-filled example, locked
            wannDay: rawWannDay,
            wannDate: rawWannDate,
            wannUhr: rawWannUhr,
            wo: rawWo,
            telefon: rawTelefon
        };

        // Aufgabe 2 correct answers (from answer key):
        // Was: Auto ansehen (pre-filled) - 1 point
        // Wann Day: Dienstag/Di (fuzzy matching) - 1 point
        // Wann Date: 12 - 1 point  
        // Wann Uhr: 14 - 1 point (counted together with date as 1+1)
        // Wo: Berner - 1 point
        // Telefon: 2582641 - 1 point
        // Total: 5 correct answers possible (Was counts as auto-correct)
        
        let score2 = 0;
        
        // Check Wann Day (1 point) - accept "Di" or "Dienstag" (with fuzzy matching)
        if (isDayCorrect(rawWannDay)) {
            score2++;
        }
        
        // Check Wann Date (1 point) - must be "12"
        const normWannDate = normalizeInput(rawWannDate);
        if (normWannDate === '12') {
            score2++;
        }
        
        // Check Wann Uhr (1 point) - must be "14"
        const normWannUhr = normalizeInput(rawWannUhr);
        if (normWannUhr === '14') {
            score2++;
        }
        
        // Check Wo (1 point) - must be "Berner" (case insensitive)
        const normWo = normalizeInput(rawWo);
        if (normWo === 'berner') {
            score2++;
        }
        
        // Check Telefon (1 point) - must be exactly "2582641"
        const normTelefon = normalizeInput(rawTelefon);
        if (normTelefon === '2582641') {
            score2++;
        }

        // Was (Auto ansehen) is pre-filled - counts as 1 correct automatically
        // But based on scoring image showing 5 max answers, Was might not count
        // Looking at "L√∂sungen pro Zeile": 1, 1+1, 1, 1 = 5 total
        // So: Was(1) + WannDay(1) + WannDate+Uhr(1+1) + Wo(1) + Telefon(1) = 5? 
        // Actually it seems Wann line has 1+1 points (day+date OR date+time)
        // With 5 blanks now: Day, Date, Uhr, Wo, Telefon = 5 answers
        // Scoring table: 5‚Üí10, 4‚Üí8, 3‚Üí6, 2‚Üí4, 1‚Üí2, 0‚Üí0
        // Looking at image: "L√∂sungen pro Zeile" shows 1, 1+1, 1, 1 = 5 total
        // The 1+1 for Wann means day and time are separate points
        // So: Was (pre-filled, 1 pt given?), Wann-Tag (1), Wann-Uhr (1), Wo (1), Telefon (1) = 5 total
        // Since Was is pre-filled as example, let's count it as 1 point automatically
        score2 += 1; // Was: Auto ansehen (pre-filled, auto-correct)
        
        // Now score2 is out of 5, use scoring table
        const aufgabe2ScoreTable = [0, 2, 4, 6, 8, 10];
        const points2 = aufgabe2ScoreTable[score2] || 0;

        // Collect Aufgabe 3 answers (Wo gef√§llt es Ihnen am besten?)
        // Correct answers: Text1=Asien, Text2=Afrika, Text3=Europa, Text4=Amerika, Text5=Afrika
        const aufgabe3CorrectAnswers = {
            1: 'Asien',
            2: 'Afrika',
            3: 'Europa',
            4: 'Amerika',
            5: 'Afrika'
        };
        
        const aufgabe3Answers = {};
        let correctCount3 = 0;
        
        for (let i = 1; i <= 5; i++) {
            const selected = document.querySelector(`input[name="aufgabe3-${i}"]:checked`);
            const userAnswer = selected ? selected.value : '';
            aufgabe3Answers[`Text${i}`] = userAnswer;
            
            // Check if answer is correct
            if (userAnswer && userAnswer === aufgabe3CorrectAnswers[i]) {
                correctCount3++;
            }
        }

        // Aufgabe 3 scoring table: 5‚Üí10, 4‚Üí8, 3‚Üí6, 2‚Üí4, 1‚Üí2, 0‚Üí0
        const aufgabe3ScoreTable = [0, 2, 4, 6, 8, 10];
        const points3 = aufgabe3ScoreTable[correctCount3] || 0;

        const totalScore = score1 + points2 + points3;

        const participantName = localStorage.getItem('studentName') || '';
        const participantEmail = localStorage.getItem('studentEmail') || '';

        const payload = {
            timestamp: new Date().toISOString(),
            name: participantName || 'Anonymous',
            email: participantEmail || 'no-email',
            examType: 'H√∂ren',
            score: totalScore,
            aufgabe1: score1,
            aufgabe2: points2,
            aufgabe3: points3
        };

        console.log('Sending payload:', JSON.stringify(payload));

        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(payload)
        }).then(() => {
            console.log('Data sent successfully');
        }).catch((err) => {
            console.error('Could not send results to sheet:', err);
        });
    }

    function showResultModal() {
        document.getElementById('result-modal').style.display = 'block';
        document.getElementById('modal-overlay').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('result-modal').style.display = 'none';
        document.getElementById('modal-overlay').style.display = 'none';
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        generatePictures();
        startTimer();
    });
</script>

</body>
</html>
